# データベース設計

## ファイル保存システム
- **画像・動画保存**: Google Cloud Storage + Cloud CDN
- **アクセスURL**: 署名付きURLによる安全なファイルアクセス
- **デフォルトアバター**: 静的ファイルとして性別別に配信
  - 男性: `https://cdn.example.com/avatars/default_male.png`
  - 女性: `https://cdn.example.com/avatars/default_female.png`

## テーブル一覧
- **users**: ユーザーアカウント情報（認証情報、基本ステータス）
- **profiles**: ユーザープロフィール情報（年齢、居住地、自己紹介、拡張項目等）
- **profile_options**: プロフィール選択肢マスターデータ（新規追加）
- **images**: プロフィール画像・動画ファイル情報
- **likes**: いいね履歴（誰が誰にいいねしたか）
- **matches**: マッチング成立情報
- **chat_rooms**: チャットルーム情報（新規追加）
- **messages**: チャットメッセージ（更新済み）
- **notifications**: プッシュ通知履歴
- **verification_documents**: 本人確認書類情報
- **points**: ポイント取引履歴（Phase2対応）

## 主要テーブルDDL

### users テーブル
```sql
CREATE TABLE users (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),
    email_verified BOOLEAN DEFAULT false,
    is_verified BOOLEAN DEFAULT false, -- 本人確認完了フラグ
    
    -- インデックス
    INDEX idx_users_email (email),
    INDEX idx_users_status (status)
);

-- RLS有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own data" ON users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own data" ON users FOR UPDATE USING (auth.uid() = id);
```

### profiles テーブル
```sql
CREATE TABLE profiles (
    id UUID REFERENCES users(id) ON DELETE CASCADE PRIMARY KEY,
    display_name VARCHAR(50) NOT NULL,
    age INTEGER NOT NULL CHECK (age >= 18 AND age <= 99),
    gender VARCHAR(10) NOT NULL CHECK (gender IN ('male', 'female', 'other')),
    prefecture VARCHAR(20) NOT NULL,
    city VARCHAR(50),
    occupation VARCHAR(50),
    bio TEXT,
    interests TEXT[], -- 趣味・興味の配列
    
    -- 希望条件
    preferred_min_age INTEGER CHECK (preferred_min_age >= 18),
    preferred_max_age INTEGER CHECK (preferred_max_age <= 99),
    preferred_prefecture VARCHAR(20),
    
    -- メディア項目
    main_image_url TEXT,
    additional_images TEXT[],
    video_url TEXT,
    
    -- 拡張プロフィール項目（Phase 1 - 基本項目）
    meeting_purpose VARCHAR(20) CHECK (meeting_purpose IN ('chat', 'friend', 'relationship', 'marriage')),
    nickname VARCHAR(30),
    height INTEGER CHECK (height >= 140 AND height <= 220),
    body_type VARCHAR(20) CHECK (body_type IN ('slim', 'normal', 'chubby', 'overweight')),
    
    -- 拡張プロフィール項目（Phase 2 - 推奨項目）
    hometown_prefecture VARCHAR(20),
    drinking VARCHAR(20) CHECK (drinking IN ('never', 'sometimes', 'often')),
    smoking VARCHAR(30) CHECK (smoking IN ('never', 'sometimes', 'often', 'quit_for_partner')),
    free_days VARCHAR(20) CHECK (free_days IN ('irregular', 'weekends', 'weekdays')),
    
    -- 拡張プロフィール項目（Phase 3 - 詳細項目）
    meeting_frequency VARCHAR(30) CHECK (meeting_frequency IN ('monthly', 'twice_monthly', 'weekly', 'multiple_weekly', 'frequent')),
    future_dreams TEXT,
    
    -- システム項目
    profile_completion_rate INTEGER DEFAULT 0 CHECK (profile_completion_rate >= 0 AND profile_completion_rate <= 100),
    last_active TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- インデックス
    INDEX idx_profiles_discovery (age, gender, prefecture),
    INDEX idx_profiles_last_active (last_active DESC),
    INDEX idx_profiles_meeting_purpose (meeting_purpose),
    INDEX idx_profiles_height (height),
    INDEX idx_profiles_body_type (body_type),
    INDEX idx_profiles_hometown (hometown_prefecture)
);

-- RLS有効化
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Profiles viewable by verified users" ON profiles 
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM users WHERE users.id = auth.uid() AND users.is_verified = true)
    );
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
```

### images テーブル
```sql
CREATE TABLE images (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    file_path VARCHAR(500) NOT NULL, -- Google Cloud Storage URL
    file_type VARCHAR(20) NOT NULL CHECK (file_type IN ('image', 'video')),
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(50) NOT NULL,
    duration INTEGER CHECK (duration <= 20), -- 動画の場合のみ、秒単位、最大20秒
    order_index INTEGER DEFAULT 0,
    is_primary BOOLEAN DEFAULT false,
    
    -- モデレーション
    moderation_status VARCHAR(20) DEFAULT 'pending' CHECK (
        moderation_status IN ('pending', 'approved', 'rejected')
    ),
    moderation_result JSONB, -- AI審査結果の詳細
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- インデックス・制約
    INDEX idx_images_user (user_id, order_index),
    UNIQUE INDEX idx_images_user_primary (user_id) WHERE is_primary = true
);

-- 画像枚数制限（最大5枚）
CREATE OR REPLACE FUNCTION check_image_limit() 
RETURNS TRIGGER AS $$
BEGIN
    IF (SELECT COUNT(*) FROM images WHERE user_id = NEW.user_id) >= 5 THEN
        RAISE EXCEPTION 'Maximum 5 images per user';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_image_limit 
    BEFORE INSERT ON images 
    FOR EACH ROW EXECUTE FUNCTION check_image_limit();

-- RLS有効化
ALTER TABLE images ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own images" ON images USING (auth.uid() = user_id);
CREATE POLICY "Approved images viewable by verified users" ON images 
    FOR SELECT USING (moderation_status = 'approved');
```

### likes テーブル
```sql
CREATE TABLE likes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    from_user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    to_user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_super_like BOOLEAN DEFAULT false, -- Phase2: スーパーいいね
    
    -- 制約
    CONSTRAINT likes_different_users CHECK (from_user_id != to_user_id),
    UNIQUE INDEX idx_likes_unique (from_user_id, to_user_id),
    
    -- インデックス
    INDEX idx_likes_from_user (from_user_id, created_at DESC),
    INDEX idx_likes_to_user (to_user_id, created_at DESC)
);

-- RLS有効化
ALTER TABLE likes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own likes" ON likes 
    FOR SELECT USING (auth.uid() = from_user_id OR auth.uid() = to_user_id);
CREATE POLICY "Users can create likes" ON likes FOR INSERT WITH CHECK (auth.uid() = from_user_id);
```

### matches テーブル
```sql
CREATE TABLE matches (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user1_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    user2_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    status VARCHAR(20) DEFAULT 'matched' CHECK (
        status IN ('matched', 'unmatched', 'blocked')
    ),
    matched_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    unmatched_at TIMESTAMP WITH TIME ZONE,
    last_message_at TIMESTAMP WITH TIME ZONE,
    
    -- 制約・インデックス
    CONSTRAINT matches_different_users CHECK (user1_id != user2_id),
    CONSTRAINT matches_user_order CHECK (user1_id < user2_id), -- 順序統一
    UNIQUE INDEX idx_matches_unique (user1_id, user2_id),
    INDEX idx_matches_user1_active (user1_id) WHERE status = 'matched',
    INDEX idx_matches_user2_active (user2_id) WHERE status = 'matched',
    INDEX idx_matches_last_message (last_message_at DESC) WHERE status = 'matched'
);

-- マッチ成立時の自動関数
CREATE OR REPLACE FUNCTION create_match_on_mutual_like()
RETURNS TRIGGER AS $$
DECLARE
    mutual_like_exists BOOLEAN;
    match_user1_id UUID;
    match_user2_id UUID;
BEGIN
    -- 相互いいねをチェック
    SELECT EXISTS(
        SELECT 1 FROM likes 
        WHERE from_user_id = NEW.to_user_id 
        AND to_user_id = NEW.from_user_id
    ) INTO mutual_like_exists;
    
    IF mutual_like_exists THEN
        -- ユーザーIDの順序を統一
        IF NEW.from_user_id < NEW.to_user_id THEN
            match_user1_id := NEW.from_user_id;
            match_user2_id := NEW.to_user_id;
        ELSE
            match_user1_id := NEW.to_user_id;
            match_user2_id := NEW.from_user_id;
        END IF;
        
        -- マッチを作成（重複チェック付き）
        INSERT INTO matches (user1_id, user2_id)
        VALUES (match_user1_id, match_user2_id)
        ON CONFLICT (user1_id, user2_id) DO NOTHING;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_match 
    AFTER INSERT ON likes 
    FOR EACH ROW EXECUTE FUNCTION create_match_on_mutual_like();

-- RLS有効化
ALTER TABLE matches ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own matches" ON matches 
    FOR SELECT USING (auth.uid() = user1_id OR auth.uid() = user2_id);
```

### chat_rooms テーブル（新規追加）
```sql
CREATE TABLE chat_rooms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    match_id UUID NOT NULL REFERENCES matches(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_message_id UUID,
    last_message_at TIMESTAMP WITH TIME ZONE,
    
    -- 同じマッチに対して複数のチャットルーム作成防止
    UNIQUE(match_id)
);

-- インデックス作成（パフォーマンス向上）
CREATE INDEX idx_chat_rooms_match ON chat_rooms (match_id);
CREATE INDEX idx_chat_rooms_updated ON chat_rooms (updated_at DESC);

-- RLS有効化
ALTER TABLE chat_rooms ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own chat rooms" ON chat_rooms
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM matches m 
            WHERE m.id = match_id 
            AND (m.user1_id = auth.uid() OR m.user2_id = auth.uid())
            AND m.status = 'matched'
        )
    );

-- チャットルーム作成時の自動処理関数
CREATE OR REPLACE FUNCTION create_or_get_chat_room(p_match_id UUID)
RETURNS UUID AS $$
DECLARE
    room_id UUID;
BEGIN
    -- 既存のチャットルームがあるかチェック
    SELECT id INTO room_id FROM chat_rooms WHERE match_id = p_match_id;
    
    -- なければ新規作成
    IF room_id IS NULL THEN
        INSERT INTO chat_rooms (match_id) VALUES (p_match_id) RETURNING id INTO room_id;
    END IF;
    
    RETURN room_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### messages テーブル（更新済み）
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    chat_room_id UUID NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'system')),
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    is_deleted BOOLEAN DEFAULT FALSE,
    
    -- メッセージは削除されても履歴として残す（論理削除）
    CHECK (LENGTH(content) > 0 AND LENGTH(content) <= 1000)
);

-- インデックス作成（パフォーマンス向上）
CREATE INDEX idx_messages_chat_room ON messages (chat_room_id, sent_at DESC);
CREATE INDEX idx_messages_sender ON messages (sender_id, sent_at DESC);
CREATE INDEX idx_messages_unread ON messages (chat_room_id, read_at) WHERE read_at IS NULL;

-- RLS有効化
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view messages in their chat rooms" ON messages
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM chat_rooms cr
            JOIN matches m ON cr.match_id = m.id
            WHERE cr.id = chat_room_id
            AND (m.user1_id = auth.uid() OR m.user2_id = auth.uid())
            AND m.status = 'matched'
        )
    );

CREATE POLICY "Users can insert messages in their chat rooms" ON messages
    FOR INSERT WITH CHECK (
        sender_id = auth.uid() AND
        EXISTS (
            SELECT 1 FROM chat_rooms cr
            JOIN matches m ON cr.match_id = m.id
            WHERE cr.id = chat_room_id
            AND (m.user1_id = auth.uid() OR m.user2_id = auth.uid())
            AND m.status = 'matched'
        )
    );

-- メッセージ挿入時のチャットルーム更新関数
CREATE OR REPLACE FUNCTION update_chat_room_on_message()
RETURNS TRIGGER AS $$
BEGIN
    -- チャットルームの最終メッセージ情報を更新
    UPDATE chat_rooms 
    SET 
        last_message_id = NEW.id,
        last_message_at = NEW.sent_at,
        updated_at = NOW()
    WHERE id = NEW.chat_room_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- メッセージ挿入時のトリガー設定
CREATE TRIGGER trigger_update_chat_room_on_message
    AFTER INSERT ON messages
    FOR EACH ROW
    EXECUTE FUNCTION update_chat_room_on_message();

-- Realtimeの有効化（リアルタイム通信用）
ALTER PUBLICATION supabase_realtime ADD TABLE messages;
ALTER PUBLICATION supabase_realtime ADD TABLE chat_rooms;
```

### verification_documents テーブル
```sql
CREATE TABLE verification_documents (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    document_type VARCHAR(30) NOT NULL CHECK (
        document_type IN ('drivers_license', 'health_insurance', 'mynumber_card')
    ),
    encrypted_file_path VARCHAR(500) NOT NULL, -- 暗号化されたファイルパス
    verification_status VARCHAR(20) DEFAULT 'pending' CHECK (
        verification_status IN ('pending', 'in_progress', 'approved', 'rejected')
    ),
    verification_result JSONB, -- AI審査結果
    verified_age INTEGER,
    rejection_reason TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days'), -- 書類削除期限
    
    -- インデックス
    INDEX idx_verification_user (user_id),
    INDEX idx_verification_status (verification_status),
    INDEX idx_verification_expires (expires_at) WHERE verification_status != 'deleted'
);

-- 自動削除機能（期限切れ書類）
CREATE OR REPLACE FUNCTION cleanup_expired_documents()
RETURNS void AS $$
BEGIN
    DELETE FROM verification_documents 
    WHERE expires_at < NOW() 
    AND verification_status IN ('approved', 'rejected');
END;
$$ LANGUAGE plpgsql;

-- 定期実行設定（日次）
SELECT cron.schedule('cleanup_documents', '0 2 * * *', 'SELECT cleanup_expired_documents();');

-- RLS有効化（管理者のみアクセス可能）
ALTER TABLE verification_documents ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin only access" ON verification_documents USING (false); -- 管理者用API経由のみ
```

### notifications テーブル
```sql
CREATE TABLE notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    notification_type VARCHAR(30) NOT NULL CHECK (
        notification_type IN ('like_received', 'match_created', 'message_received', 'system')
    ),
    title VARCHAR(100) NOT NULL,
    body VARCHAR(500) NOT NULL,
    data JSONB, -- 追加データ（match_id, message_id等）
    
    is_read BOOLEAN DEFAULT false,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    read_at TIMESTAMP WITH TIME ZONE,
    
    -- インデックス
    INDEX idx_notifications_user_unread (user_id) WHERE is_read = false,
    INDEX idx_notifications_user_time (user_id, sent_at DESC)
);

-- RLS有効化
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own notifications" ON notifications 
    FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can update own notifications" ON notifications 
    FOR UPDATE USING (auth.uid() = user_id);
```

### points テーブル（Phase2対応）
```sql
CREATE TABLE points (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    transaction_type VARCHAR(20) NOT NULL CHECK (
        transaction_type IN ('purchase', 'consume', 'bonus', 'refund')
    ),
    amount INTEGER NOT NULL, -- 正数=獲得、負数=消費
    balance_after INTEGER NOT NULL CHECK (balance_after >= 0),
    description VARCHAR(200) NOT NULL,
    related_entity_type VARCHAR(20), -- 'like', 'super_like'等
    related_entity_id UUID,
    receipt_data JSONB, -- アプリストア購入レシート情報（purchase時のみ）
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- インデックス
    INDEX idx_points_user_time (user_id, created_at DESC),
    INDEX idx_points_balance (user_id, balance_after) -- 最新残高取得用
);

-- ポイント残高計算用ビュー
CREATE VIEW user_points_balance AS
SELECT 
    user_id,
    COALESCE(SUM(amount), 0) as total_balance,
    MAX(created_at) as last_transaction_at
FROM points 
GROUP BY user_id;

-- RLS有効化
ALTER TABLE points ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own points" ON points 
    FOR SELECT USING (auth.uid() = user_id);
```

### profile_options テーブル（新規追加）
```sql
CREATE TABLE profile_options (
    category VARCHAR(50) NOT NULL,
    value VARCHAR(50) NOT NULL,
    label_ja VARCHAR(100) NOT NULL,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    
    PRIMARY KEY (category, value),
    
    -- インデックス
    INDEX idx_profile_options_category (category, sort_order),
    INDEX idx_profile_options_active (category, is_active) WHERE is_active = true
);

-- 選択肢データの挿入
INSERT INTO profile_options (category, value, label_ja, sort_order) VALUES
-- 出会いの目的
('meeting_purpose', 'chat', 'チャット相手', 1),
('meeting_purpose', 'friend', '友達', 2),
('meeting_purpose', 'relationship', '恋人', 3),
('meeting_purpose', 'marriage', '結婚相手', 4),

-- 体型
('body_type', 'slim', 'スリム', 1),
('body_type', 'normal', '普通', 2),
('body_type', 'chubby', 'ぽっちゃり', 3),
('body_type', 'overweight', '太め', 4),

-- 飲酒
('drinking', 'never', '飲まない', 1),
('drinking', 'sometimes', '時々', 2),
('drinking', 'often', 'よく飲む', 3),

-- 喫煙
('smoking', 'never', '吸わない', 1),
('smoking', 'sometimes', '時々', 2),
('smoking', 'often', 'よく吸う', 3),
('smoking', 'quit_for_partner', '相手が嫌がれば禁煙', 4),

-- 休日
('free_days', 'irregular', '不定期', 1),
('free_days', 'weekends', '土日', 2),
('free_days', 'weekdays', '平日', 3),

-- 会う頻度
('meeting_frequency', 'monthly', '月1回', 1),
('meeting_frequency', 'twice_monthly', '月2回', 2),
('meeting_frequency', 'weekly', '週1回', 3),
('meeting_frequency', 'multiple_weekly', '週2-3回', 4),
('meeting_frequency', 'frequent', '週4回以上', 5)

ON CONFLICT (category, value) DO NOTHING;

-- RLS有効化
ALTER TABLE profile_options ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Profile options readable by authenticated users" ON profile_options
    FOR SELECT USING (auth.role() = 'authenticated');
```

## リレーション
- **users.id** → **profiles.id**（1対1）
- **users.id** → **images.user_id**（1対多）
- **users.id** → **likes.from_user_id**（1対多）
- **users.id** → **likes.to_user_id**（1対多）
- **users.id** → **matches.user1_id**（1対多）
- **users.id** → **matches.user2_id**（1対多）
- **matches.id** → **chat_rooms.match_id**（1対1）
- **chat_rooms.id** → **messages.chat_room_id**（1対多）
- **profiles.id** → **messages.sender_id**（1対多）
- **users.id** → **notifications.user_id**（1対多）
- **users.id** → **verification_documents.user_id**（1対多）
- **users.id** → **points.user_id**（1対多、Phase2）

## チャット機能のデータ構造

### チャットルーム作成フロー
1. マッチ成立時：`matches`テーブルにレコード挿入
2. 初回メッセージ送信時：`create_or_get_chat_room()`関数でチャットルーム自動作成
3. メッセージ送信時：`messages`テーブルにレコード挿入→トリガーでチャットルーム更新

### リアルタイム機能
- **Supabase Realtime**を使用したリアルタイムメッセージング
- `messages`テーブルと`chat_rooms`テーブルで変更通知受信
- オンラインプレゼンス機能でユーザーのオンライン状態管理

### セキュリティ
- **RLS（行レベルセキュリティ）**で適切なアクセス制御
- EdgeFunctionでService Role Key使用によるセキュアなAPI
- チャット参加者のみがメッセージ閲覧・送信可能