# マッチングアプリ アーキテクチャ設計書（個人開発向け）

## 技術スタック
- **フロントエンド**: React Native + Expo
- **バックエンド**: Supabase Edge Functions (Deno)
- **データベース**: Supabase PostgreSQL + RLS
- **認証**: Supabase Auth (JWT)
- **リアルタイム通信**: Supabase Realtime
- **ストレージ**: Supabase Storage + Google Cloud Storage
- **通知・音響**: Expo Haptics + Expo Audio
- **インフラ**: Supabase + Google Cloud Storage + Cloud CDN
- **画像処理**: Vision API (画像審査)
- **チャット**: リアルタイムメッセージング

## システム構成図

```mermaid
graph TB
    subgraph "Client Layer"
        A[iOS App<br/>React Native + Expo]
        B[Android App<br/>React Native + Expo]
        A1[Haptics + Audio<br/>フィードバック・通知音]
    end
    
    subgraph "API Gateway & Edge Functions"
        C[Supabase Edge Functions<br/>Deno Runtime]
        C1[get-recommended-profiles]
        C2[get-matches-with-profiles]
        C3[get-partner-profile]
        C4[get-chat-list]
        C5[get-chat-messages]
        C6[send-message]
    end
    
    subgraph "Backend Services"
        D[Supabase Auth<br/>認証・認可・JWT]
        E[Supabase Database<br/>PostgreSQL + RLS]
        E1[Users & Profiles]
        E2[Likes & Matches]
        E3[Chat Rooms & Messages]
        F[Supabase Realtime<br/>WebSocket・チャット]
        G[Supabase Storage<br/>ファイル保存]
    end
    
    subgraph "External Services"
        H[Google Cloud Storage<br/>画像・動画保存]
        I[Cloud CDN<br/>配信最適化]
        J[Vision API<br/>画像審査]
        L[FCM/APNs<br/>プッシュ通知]
    end
    
    subgraph "App Stores"
        M[App Store]
        N[Google Play]
    end
    
    A --> C
    B --> C
    A --> A1
    A --> F
    
    C --> C1
    C --> C2
    C --> C3
    C --> C4
    C --> C5
    C --> C6
    
    C --> D
    C --> E
    E --> E1
    E --> E2
    E --> E3
    F --> E3
    C --> G
    
    G --> H
    H --> I
    C --> J
    C --> L
    
    A --> M
    B --> N
    
    classDef client fill:#e1f5fe
    classDef backend fill:#f3e5f5
    classDef external fill:#fff3e0
    classDef store fill:#e8f5e8
    classDef functions fill:#e8f6ff
    
    class A,B,A1 client
    class C,C1,C2,C3,C4,C5,C6 functions
    class D,E,E1,E2,E3,F,G backend
    class H,I,J,L external
    class M,N store
```

## 選択理由

- **React Native + Expo**: 個人開発に最適。一つのコードベースでiOS/Android対応、豊富なライブラリとExpoの簡単なビルド・デプロイ機能
- **Supabase**: Firebase代替のオープンソースBaaS。PostgreSQL、認証、リアルタイム、ストレージを統合提供。個人開発者に優しい料金体系
- **Supabase Edge Functions**: Deno Runtime上でのサーバーレス関数。TypeScriptネイティブサポート。セキュアなAPI実装が可能
- **Supabase PostgreSQL**: 高機能なリレーショナルDB。Row Level Security（RLS）でセキュアなマルチテナント設計が可能
- **Supabase Auth**: JWT認証、OAuth対応、メール認証など必要な認証機能を簡単に実装。追加コストなし
- **Supabase Realtime**: PostgreSQLの変更をリアルタイムでクライアントに通知。WebSocketベースでリアルタイムチャット機能を実現
- **Supabase Storage**: ファイル保存・配信。RLSによるセキュアなファイルアクセス制御
- **Google Cloud Storage + Cloud CDN**: 画像・動画の大容量ストレージとCDN配信。従量課金で小規模時は低コスト
- **Vision API**: 画像の自動審査（不適切コンテンツ検出、SafeSearch）。人手での審査コストを大幅削減。高精度な日本語対応
- **Expo Haptics + Audio**: ネイティブな触覚フィードバックと音響効果。UX向上に貢献

## 初期コスト（Initial）
- **Apple Developer Program**: $99
- **Google Play Developer**: $25
- **ドメイン取得**: $15
- **SSL証明書**: $0 (Let's Encrypt)
- **開発ツール**: $0 (オープンソース)
- **合計**: $139

## ランニングコスト

### Phase 1 (MVP - ~100ユーザー)
- **Supabase Pro**: $25/月
- **Google Cloud Storage**: $3/月 (50GB想定)
- **Cloud CDN**: $2/月
- **Vision API**: $8/月 (1000画像/月想定)
- **ドメイン**: $1/月
- **合計**: $39/月 ($468/年)

**チャット機能追加による変更点:**
- リアルタイム通信による帯域幅使用量微増（Supabase Pro内で対応）
- メッセージ保存によるDB容量微増（同上）
- 通知音・ハプティクス機能は追加コストなし（Expo標準機能）

### Phase 2 (成長期 - ~1000ユーザー)
- **Supabase Pro**: $25/月
- **Google Cloud Storage**: $12/月 (200GB想定)
- **Cloud CDN**: $8/月
- **Vision API**: $40/月 (5000画像/月想定)
- **プッシュ通知 (FCM/APNs)**: $0 (無料枠内)
- **ドメイン**: $1/月
- **合計**: $86/月 ($1,032/年)

### Phase 3 (スケール期 - 1000ユーザー超)
- **Supabase Team**: $599/月
- **Google Cloud Storage**: $30/月 (500GB想定)
- **Cloud CDN**: $25/月
- **Vision API**: $120/月 (15000画像/月想定)
- **外部年齢確認サービス**: $100/月
- **ドメイン**: $1/月
- **合計**: $875/月 ($10,500/年)

## アーキテクチャの特徴

### 🎯 個人開発最適化
- **ワンストップ開発**: Supabaseで認証・DB・API・リアルタイムを統合管理
- **ノーコード/ローコード**: 管理画面、分析ダッシュボードが標準装備
- **簡単デプロイ**: Expo EAS Buildで自動ビルド・ストア申請

### 💰 コスト効率
- **従量課金**: 利用量に応じた料金体系で初期は低コスト
- **無料枠活用**: 多くのサービスで無料枠を最大限活用
- **運用自動化**: 手動運用を最小限に抑制

### 🔒 セキュリティ
- **RLS（Row Level Security）**: データベースレベルでのアクセス制御
- **JWT認証**: ステートレスで安全な認証システム
- **HTTPS/WSS**: 全通信の暗号化

### 📈 スケーラビリティ
- **段階的成長**: ユーザー数に応じてプラン変更で対応
- **マネージドサービス**: インフラ管理の負担を最小化
- **マイクロサービス化**: 必要に応じて機能を分離可能

## チャット機能アーキテクチャ詳細

### リアルタイムメッセージング構成
```mermaid
graph LR
    subgraph "Client"
        A[ChatScreen]
        B[ChatService]
        C[SoundService]
    end
    
    subgraph "Edge Functions"
        D[get-chat-list]
        E[get-chat-messages]
        F[send-message]
    end
    
    subgraph "Supabase Services"
        G[Realtime WebSocket]
        H[PostgreSQL]
        I[Auth JWT]
    end
    
    A --> B
    B --> D
    B --> E
    B --> F
    B --> G
    A --> C
    
    D --> H
    E --> H
    F --> H
    F --> I
    G --> H
```

### チャットデータフロー
1. **チャット一覧表示**:
   - `get-chat-list` EdgeFunction → マッチ情報 + 最終メッセージ + 未読数を一括取得
   - Service Role Key使用でRLSバイパス、セキュアなデータ統合

2. **メッセージ送信**:
   - `send-message` EdgeFunction → チャットルーム作成/取得 → メッセージ挿入
   - PostgreSQL トリガーでチャットルーム最終更新時刻を自動更新

3. **リアルタイム受信**:
   - Supabase Realtime → `messages`テーブル変更監視
   - INSERT/UPDATE イベントでクライアントへ即座に配信
   - 音響フィードバック（SoundService）とハプティクス自動実行

### セキュリティレイヤー
- **JWT認証**: 全EdgeFunctionでBearer Token検証
- **マッチ関係確認**: 送信者がマッチ相手であることを強制検証
- **RLS**: データベースレベルでの多重アクセス制御
- **Service Role Key**: EdgeFunction内でのセキュアなデータ操作

### パフォーマンス最適化
- **インデックス最適化**: メッセージ取得・未読数計算の高速化
- **データページネーション**: 50件単位でのメッセージ取得
- **リアルタイム帯域制御**: 必要最小限のデータのみ配信
- **クライアント側キャッシュ**: ChatServiceでのローカル状態管理

## リスク軽減策

### 技術的リスク
- **Vendor Lock-in対策**: Supabaseはオープンソースのため、必要時に自前環境への移行が可能
- **障害対応**: マネージドサービスの冗長化とバックアップ体制
- **パフォーマンス**: CDN活用と適切なインデックス設計

### 運用リスク
- **法的対応**: 利用規約の厳格化と段階的なコンテンツモデレーション
- **コスト管理**: アラート設定と定期的な利用量監視
- **セキュリティ**: 定期的なアクセス権限見直しと脆弱性対応

この設計により、個人開発でも安全で拡張性のあるマッチングアプリを低コストで構築・運用することが可能です。特にGCPの採用により、画像処理の精度向上と若干のコスト削減を実現しています。